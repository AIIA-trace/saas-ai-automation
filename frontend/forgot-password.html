<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar contraseña - IA Receptionist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">
    <!-- Header -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-robot me-2"></i>IA Receptionist
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-light text-primary ms-3" href="login.html">Iniciar sesión</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Password Recovery Form -->
    <section class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-md-8">
                    <div class="card shadow-lg border-0 rounded-lg">
                        <div class="card-header bg-white text-center py-4">
                            <h2 class="mb-0">Recuperar contraseña</h2>
                            <p class="text-muted">Enviaremos un enlace a tu correo electrónico</p>
                        </div>
                        <div class="card-body p-4 p-md-5">
                            <div id="requestForm">
                                <div class="alert alert-info mb-4" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Introduce tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.
                                </div>
                                
                                <form id="forgotPasswordForm">
                                    <div id="requestAlert" class="alert d-none" role="alert"></div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Correo electrónico</label>
                                        <input type="email" class="form-control" id="email" required>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                                            Enviar enlace de recuperación <i class="fas fa-paper-plane ms-2"></i>
                                        </button>
                                    </div>
                                </form>
                                
                                <hr class="my-4">
                                
                                <div class="text-center">
                                    <a href="login.html" class="btn btn-link">
                                        <i class="fas fa-arrow-left me-2"></i> Volver al inicio de sesión
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Success state (initially hidden) -->
                            <div id="successState" class="text-center d-none">
                                <div class="mb-4">
                                    <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                                </div>
                                <h3 class="mb-3">¡Correo enviado!</h3>
                                <p class="mb-4">Hemos enviado un enlace de recuperación a tu dirección de correo electrónico. Por favor, revisa tu bandeja de entrada y sigue las instrucciones.</p>
                                <a href="login.html" class="btn btn-primary">
                                    Volver al inicio de sesión
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Reset Password Form (for the reset page) -->
    <section class="py-5 d-none" id="resetPasswordSection">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-md-8">
                    <div class="card shadow-lg border-0 rounded-lg">
                        <div class="card-header bg-white text-center py-4">
                            <h2 class="mb-0">Establecer nueva contraseña</h2>
                            <p class="text-muted">Crea una contraseña nueva y segura</p>
                        </div>
                        <div class="card-body p-4 p-md-5">
                            <form id="resetPasswordForm">
                                <div id="resetAlert" class="alert d-none" role="alert"></div>
                                
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">Nueva contraseña</label>
                                    <input type="password" class="form-control" id="newPassword" 
                                           minlength="8" required>
                                    <small class="text-muted">Mínimo 8 caracteres</small>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                                    <input type="password" class="form-control" id="confirmPassword" 
                                           minlength="8" required>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" id="resetButton">
                                        Restablecer contraseña <i class="fas fa-key ms-2"></i>
                                    </button>
                                </div>
                                
                                <input type="hidden" id="resetToken">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer py-4 bg-dark text-white mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h3><i class="fas fa-robot me-2"></i>IA Receptionist</h3>
                    <p>Automatización inteligente de comunicaciones para empresas de todos los tamaños.</p>
                </div>
                <div class="col-md-3">
                    <h5>Enlaces</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html" class="text-white">Inicio</a></li>
                        <li><a href="login.html" class="text-white">Iniciar sesión</a></li>
                        <li><a href="register.html" class="text-white">Registrarse</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contacto</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-envelope me-2"></i> info@ia-receptionist.com</li>
                        <li><i class="fas fa-phone me-2"></i> +34 91 123 45 67</li>
                    </ul>
                </div>
            </div>
            <hr class="mt-4">
            <div class="text-center">
                <p class="mb-0">&copy; 2025 IA Receptionist. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <!-- Configuración y servicios -->
    <script src="js/api-config.js"></script>
    <script src="js/auth-service.js"></script>
    
    <script>
        // Configuración de toastr
        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: "toast-top-right",
            timeOut: 5000
        };
        
        // Redireccionar si ya está autenticado
        if (authService.isAuthenticated()) {
            window.location.href = 'dashboard.html';
        }
        
        // Check URL parameters
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            // If token is present, show reset form
            if (token) {
                document.getElementById('resetPasswordSection').classList.remove('d-none');
                document.getElementById('resetToken').value = token;
                document.getElementById('forgotPasswordSection')?.classList.add('d-none');
            }
        };
        
        // Request password reset form
        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            if (!email) {
                toastr.warning('Por favor ingresa tu correo electrónico', 'Campos requeridos');
                return;
            }
            
            // Disable button and show loading state
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Enviando...';
            
            // Usar el servicio de autenticación
            authService.requestPasswordReset(email)
                .then(() => {
                    // Always show success to prevent email enumeration
                    document.getElementById('requestForm').classList.add('d-none');
                    document.getElementById('successState').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Mostrar error (pero sin revelar si el email existe o no)
                    toastr.info('Si tu correo existe en nuestra base de datos, recibirás un enlace de recuperación', 'Solicitud procesada');
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Enviar enlace de recuperación <i class="fas fa-paper-plane ms-2"></i>';
                });
        });
        
        // Reset password form
        document.getElementById('resetPasswordForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const token = document.getElementById('resetToken').value;
            
            if (!newPassword || !confirmPassword) {
                toastr.warning('Por favor completa todos los campos', 'Campos requeridos');
                return;
            }
            
            if (newPassword.length < 8) {
                toastr.warning('La contraseña debe tener al menos 8 caracteres', 'Validación');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                toastr.warning('Las contraseñas no coinciden', 'Validación');
                return;
            }
            
            // Disable button and show loading state
            const resetButton = document.getElementById('resetButton');
            resetButton.disabled = true;
            resetButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Procesando...';
            
            // Usar el servicio de autenticación
            authService.resetPassword(token, newPassword)
                .then(data => {
                    // Mostrar mensaje de éxito
                    toastr.success('Contraseña restablecida exitosamente', 'Éxito');
                    
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Mostrar mensaje de error
                    toastr.error(error.message || 'Error al restablecer la contraseña', 'Error');
                    
                    // Reset button
                    resetButton.disabled = false;
                    resetButton.innerHTML = 'Restablecer contraseña <i class="fas fa-key ms-2"></i>';
                });
        });
    </script>
</body>
</html>
