<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema de Tokens</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🧪 Test Sistema de Manejo de Tokens</h1>
    
    <div id="status" class="status info">Cargando sistema...</div>
    
    <button onclick="testExpiredToken()">1. Establecer Token Expirado</button>
    <button onclick="testDashboard()">2. Ir al Dashboard</button>
    <button onclick="clearAll()">3. Limpiar Todo</button>
    <button onclick="checkStatus()">4. Verificar Estado</button>
    
    <div id="logs"></div>

    <!-- Scripts necesarios en el mismo orden que el dashboard -->
    <script src="js/api-config.js"></script>
    <script src="js/api-helper.js"></script>
    <script src="js/auth-service.js"></script>
    <script src="js/token-validator.js"></script>
    <script src="js/route-protection.js"></script>
    
    <script>
        let logContainer = document.getElementById('logs');
        let statusContainer = document.getElementById('status');
        
        function log(message, type = 'info') {
            console.log(message);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            statusContainer.className = `status ${type}`;
            statusContainer.innerHTML = message;
        }
        
        function testExpiredToken() {
            log('🧹 Limpiando tokens existentes...', 'info');
            
            // Limpiar tokens
            localStorage.removeItem('auth_token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user_data');
            localStorage.removeItem('api_key');
            localStorage.removeItem('auth_timestamp');
            
            // Token JWT expirado (exp: 1640995200 = 1 enero 2022)
            const expiredToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjEyMyIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJ1c2VyIiwiZXhwIjoxNjQwOTk1MjAwfQ.K8i6QQnNQQnNQQnNQQnNQQnNQQnNQQnNQQnNQQnNQQnN';
            
            localStorage.setItem('auth_token', expiredToken);
            localStorage.setItem('authToken', expiredToken);
            localStorage.setItem('user_data', JSON.stringify({
                id: '123',
                email: 'test@example.com',
                role: 'user'
            }));
            
            log('⚠️ Token expirado establecido', 'warning');
            updateStatus('Token expirado establecido - Listo para probar', 'warning');
            
            // Verificar con TokenValidator
            if (window.TokenValidator) {
                const tokenInfo = window.TokenValidator.getCurrentTokenInfo();
                if (tokenInfo) {
                    log(`📊 Token válido: ${tokenInfo.isValid}`, tokenInfo.isValid ? 'success' : 'error');
                    log(`📅 Expira en: ${tokenInfo.expiresIn} segundos`, 'info');
                } else {
                    log('❌ No se pudo obtener información del token', 'error');
                }
            } else {
                log('❌ TokenValidator no disponible', 'error');
            }
        }
        
        function testDashboard() {
            log('🔄 Redirigiendo al dashboard para probar sistema...', 'info');
            updateStatus('Redirigiendo al dashboard...', 'info');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        }
        
        function clearAll() {
            localStorage.clear();
            window.tokenVerified = false;
            window.isRedirecting = false;
            log('🧹 Todo limpiado', 'success');
            updateStatus('Todo limpiado - Sistema resetado', 'success');
        }
        
        function checkStatus() {
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                log('ℹ️ No hay token en localStorage', 'info');
                updateStatus('No hay token - Usuario no autenticado', 'info');
                return;
            }
            
            log(`🔑 Token encontrado: ${token.substring(0, 50)}...`, 'info');
            
            if (window.TokenValidator) {
                const tokenInfo = window.TokenValidator.getCurrentTokenInfo();
                if (tokenInfo) {
                    log(`👤 Usuario: ${tokenInfo.user.email}`, 'info');
                    log(`✅ Válido: ${tokenInfo.isValid}`, tokenInfo.isValid ? 'success' : 'error');
                    log(`⏰ Expira en: ${tokenInfo.expiresIn} segundos`, 'info');
                    log(`📅 Expira el: ${tokenInfo.expiresAt}`, 'info');
                    
                    updateStatus(
                        `Token ${tokenInfo.isValid ? 'VÁLIDO' : 'EXPIRADO'} - Usuario: ${tokenInfo.user.email}`,
                        tokenInfo.isValid ? 'success' : 'error'
                    );
                } else {
                    log('❌ No se pudo decodificar el token', 'error');
                    updateStatus('Token inválido o corrupto', 'error');
                }
            } else {
                log('❌ TokenValidator no disponible', 'error');
                updateStatus('Sistema de validación no disponible', 'error');
            }
        }
        
        // Auto-verificar al cargar
        window.onload = function() {
            setTimeout(() => {
                log('✅ Sistema de tokens cargado', 'success');
                checkStatus();
            }, 1000);
        };
    </script>
</body>
</html>
