<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Verificaci√≥n REAL - Cada Campo Individualmente</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; margin: 15px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .field-test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .field-test.success { border-color: #28a745; background: #f8fff9; }
        .field-test.error { border-color: #dc3545; background: #fff8f8; }
        .field-test.testing { border-color: #ffc107; background: #fffdf5; }
        
        .field-header { font-weight: bold; margin-bottom: 5px; }
        .field-details { font-size: 12px; color: #666; margin: 5px 0; }
        .field-values { font-family: monospace; font-size: 11px; background: #f8f9fa; padding: 5px; border-radius: 3px; }
        
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        
        #summary { position: fixed; top: 20px; right: 20px; width: 300px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .summary-stat { margin: 5px 0; }
        .success-count { color: #28a745; font-weight: bold; }
        .error-count { color: #dc3545; font-weight: bold; }
        .testing-count { color: #ffc107; font-weight: bold; }
        
        #log { height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verificaci√≥n REAL - Cada Campo Individualmente</h1>
        <p><strong>Esta herramienta prueba CADA campo por separado para detectar exactamente qu√© falla y qu√© funciona.</strong></p>
        
        <div id="summary">
            <h4>üìä Resumen en Tiempo Real</h4>
            <div class="summary-stat">‚úÖ Exitosos: <span id="success-count" class="success-count">0</span></div>
            <div class="summary-stat">‚ùå Fallidos: <span id="error-count" class="error-count">0</span></div>
            <div class="summary-stat">üîÑ Probando: <span id="testing-count" class="testing-count">0</span></div>
            <div class="summary-stat">üìã Total: <span id="total-count">0</span></div>
            <hr>
            <div class="summary-stat">üéØ Precisi√≥n: <span id="accuracy">0%</span></div>
        </div>

        <div class="test-section">
            <h3>üîß Controles</h3>
            <button class="btn-primary" onclick="runCompleteTest()">üöÄ Ejecutar Test Completo</button>
            <button class="btn-warning" onclick="testIndividualFields()">üîç Test Campo por Campo</button>
            <button class="btn-success" onclick="testPersistence()">üíæ Test de Persistencia</button>
            <button class="btn-danger" onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
        </div>

        <!-- Informaci√≥n de Empresa -->
        <div class="test-section">
            <h3>üè¢ Informaci√≥n de Empresa</h3>
            <div id="company-fields"></div>
        </div>

        <!-- Configuraci√≥n del Bot -->
        <div class="test-section">
            <h3>ü§ñ Configuraci√≥n del Bot</h3>
            <div id="bot-fields"></div>
        </div>

        <!-- Configuraci√≥n de Llamadas -->
        <div class="test-section">
            <h3>üìû Configuraci√≥n de Llamadas</h3>
            <div id="call-fields"></div>
        </div>

        <!-- Configuraci√≥n de IA -->
        <div class="test-section">
            <h3>üß† Configuraci√≥n de IA</h3>
            <div id="ai-fields"></div>
        </div>

        <!-- Configuraci√≥n de Email -->
        <div class="test-section">
            <h3>üìß Configuraci√≥n de Email</h3>
            <div id="email-fields"></div>
        </div>

        <div class="test-section">
            <h3>üìã Log de Consola</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n para PRODUCCI√ìN DIRECTA
        const API_BASE_URL = 'https://agente-ia-backend.onrender.com/api';
        const API_BASE = 'https://agente-ia-backend.onrender.com';
        
        // Definici√≥n de todos los campos a probar
        const FIELD_DEFINITIONS = {
            company: [
                { id: 'company_name', backendField: 'companyName', dbPath: 'companyInfo.name', testValue: 'Empresa Test Real' },
                { id: 'main_phone', backendField: 'companyPhone', dbPath: 'companyInfo.phone', testValue: '+34 987 654 321' },
                { id: 'contact_email', backendField: 'companyEmail', dbPath: 'companyInfo.email', testValue: 'test@real.com' },
                { id: 'industry', backendField: 'companySector', dbPath: 'companyInfo.sector', testValue: 'technology' },
                { id: 'company_address', backendField: 'companyAddress', dbPath: 'companyInfo.address', testValue: 'Calle Test 123' },
                { id: 'company_website', backendField: 'companyWebsite', dbPath: 'companyInfo.website', testValue: 'https://test.com' }
            ],
            bot: [
                { id: 'bot_name', backendField: 'botName', dbPath: 'botConfig.name', testValue: 'Bot Test Real' },
                { id: 'bot_personality', backendField: 'botPersonality', dbPath: 'botConfig.personality', testValue: 'professional' },
                { id: 'welcome_message', backendField: 'welcomeMessage', dbPath: 'botConfig.welcomeMessage', testValue: 'Bienvenido test' },

            ],
            call: [
                { id: 'call_language', backendField: 'callConfig.language', dbPath: 'botConfig.callConfig.language', testValue: 'es-ES' },
                { id: 'voice_type', backendField: 'callConfig.voiceId', dbPath: 'botConfig.callConfig.voiceId', testValue: 'female' },
                { id: 'call_greeting', backendField: 'callConfig.greeting', dbPath: 'botConfig.callConfig.greeting', testValue: 'Hola, test de saludo' }
            ],
            ai: [
                { id: 'ai_temperature', backendField: 'aiConfig.temperature', dbPath: 'botConfig.aiConfig.temperature', testValue: 0.8 },
                { id: 'ai_max_tokens', backendField: 'aiConfig.maxTokens', dbPath: 'botConfig.aiConfig.maxTokens', testValue: 200 },
                { id: 'ai_top_p', backendField: 'aiConfig.topP', dbPath: 'botConfig.aiConfig.topP', testValue: 0.9 },
                { id: 'ai_frequency_penalty', backendField: 'aiConfig.frequencyPenalty', dbPath: 'botConfig.aiConfig.frequencyPenalty', testValue: 0.1 },
                { id: 'ai_presence_penalty', backendField: 'aiConfig.presencePenalty', dbPath: 'botConfig.aiConfig.presencePenalty', testValue: 0.2 }
            ],
            email: [
                { id: 'email_provider', backendField: 'emailConfig.provider', dbPath: 'emailConfig.provider', testValue: 'gmail' },
                { id: 'outgoing_email', backendField: 'emailConfig.outgoingEmail', dbPath: 'emailConfig.outgoingEmail', testValue: 'test@gmail.com' },
                { id: 'imap_server', backendField: 'emailConfig.imapServer', dbPath: 'emailConfig.imapServer', testValue: 'imap.gmail.com' },
                { id: 'imap_port', backendField: 'emailConfig.imapPort', dbPath: 'emailConfig.imapPort', testValue: 993 },
                { id: 'smtp_server', backendField: 'emailConfig.smtpServer', dbPath: 'emailConfig.smtpServer', testValue: 'smtp.gmail.com' },
                { id: 'smtp_port', backendField: 'emailConfig.smtpPort', dbPath: 'emailConfig.smtpPort', testValue: 587 },
                { id: 'use_ssl', backendField: 'emailConfig.useSSL', dbPath: 'emailConfig.useSSL', testValue: true },
                { id: 'email_signature', backendField: 'emailConfig.emailSignature', dbPath: 'emailConfig.emailSignature', testValue: 'Firma de test' }
            ]
        };

        let testResults = {};
        let currentTestCount = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateSummary() {
            const results = Object.values(testResults);
            const success = results.filter(r => r.status === 'success').length;
            const error = results.filter(r => r.status === 'error').length;
            const testing = results.filter(r => r.status === 'testing').length;
            const total = results.length;
            
            document.getElementById('success-count').textContent = success;
            document.getElementById('error-count').textContent = error;
            document.getElementById('testing-count').textContent = testing;
            document.getElementById('total-count').textContent = total;
            document.getElementById('accuracy').textContent = total > 0 ? Math.round((success / total) * 100) + '%' : '0%';
        }

        function createFieldTestElement(category, field) {
            const div = document.createElement('div');
            div.className = 'field-test';
            div.id = `test-${field.id}`;
            
            div.innerHTML = `
                <div class="field-header">${field.id} ‚Üí ${field.backendField}</div>
                <div class="field-details">DB Path: ${field.dbPath}</div>
                <div class="field-details">Test Value: ${JSON.stringify(field.testValue)}</div>
                <div class="field-values" id="values-${field.id}">Esperando test...</div>
            `;
            
            return div;
        }

        function initializeFieldTests() {
            Object.keys(FIELD_DEFINITIONS).forEach(category => {
                const container = document.getElementById(`${category}-fields`);
                FIELD_DEFINITIONS[category].forEach(field => {
                    container.appendChild(createFieldTestElement(category, field));
                });
            });
        }

        async function getAuthToken() {
            // Primero intentar obtener token existente
            let token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            
            if (!token) {
                // Si no hay token, solicitar credenciales para producci√≥n
                const email = prompt('Email para producci√≥n:');
                const password = prompt('Password para producci√≥n:');
                
                if (email && password) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            token = data.token;
                            localStorage.setItem('authToken', token);
                            log(`‚úÖ Token obtenido para producci√≥n`);
                        } else {
                            log(`‚ùå Error de login: ${response.status}`);
                        }
                    } catch (error) {
                        log(`‚ùå Error conectando a producci√≥n: ${error.message}`);
                    }
                }
            }
            
            return token;
        }

        async function testSingleField(category, field) {
            const fieldId = field.id;
            const testElement = document.getElementById(`test-${fieldId}`);
            const valuesElement = document.getElementById(`values-${fieldId}`);
            
            try {
                // Marcar como testing
                testResults[fieldId] = { status: 'testing', field: field };
                testElement.className = 'field-test testing';
                valuesElement.innerHTML = 'üîÑ Probando...';
                updateSummary();
                
                log(`üîç Probando campo: ${fieldId}`, 'info');
                
                const token = await getAuthToken();
                if (!token) {
                    throw new Error('No hay token de autenticaci√≥n');
                }

                // 1. Cargar configuraci√≥n actual
                const loadResponse = await fetch(`${API_BASE}/api/config/bot`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!loadResponse.ok) {
                    throw new Error(`Error cargando: ${loadResponse.status}`);
                }

                const currentData = await loadResponse.json();
                
                // 2. Preparar datos de test
                const testData = buildTestPayload(fieldId, field, field.testValue);
                
                // 3. Enviar datos de test
                const saveResponse = await fetch(`${API_BASE}/api/config/bot`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    throw new Error(`Error guardando: ${saveResponse.status} - ${errorText}`);
                }

                const saveResult = await saveResponse.json();
                
                // 4. Verificar que se guard√≥ correctamente
                await new Promise(resolve => setTimeout(resolve, 500)); // Esperar un poco
                
                const verifyResponse = await fetch(`${API_BASE}/api/config/bot`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!verifyResponse.ok) {
                    throw new Error(`Error verificando: ${verifyResponse.status}`);
                }

                const verifiedData = await verifyResponse.json();
                
                // 5. Comparar valores
                const actualValue = getValueFromPath(verifiedData, field.dbPath);
                const expectedValue = field.testValue;
                
                const isMatch = compareValues(actualValue, expectedValue);
                
                if (isMatch) {
                    testResults[fieldId] = { status: 'success', field: field, actualValue, expectedValue };
                    testElement.className = 'field-test success';
                    valuesElement.innerHTML = `‚úÖ √âXITO<br>Enviado: ${JSON.stringify(expectedValue)}<br>Recibido: ${JSON.stringify(actualValue)}`;
                    log(`‚úÖ ${fieldId}: √âXITO`, 'success');
                } else {
                    throw new Error(`Valor no coincide. Esperado: ${JSON.stringify(expectedValue)}, Actual: ${JSON.stringify(actualValue)}`);
                }

            } catch (error) {
                testResults[fieldId] = { status: 'error', field: field, error: error.message };
                testElement.className = 'field-test error';
                valuesElement.innerHTML = `‚ùå ERROR<br>${error.message}`;
                log(`‚ùå ${fieldId}: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        function buildTestPayload(fieldId, field, testValue) {
            const payload = {};
            
            // Construir payload basado en la categor√≠a del campo
            if (field.backendField.includes('.')) {
                const parts = field.backendField.split('.');
                if (parts[0] === 'callConfig') {
                    payload.callConfig = { [parts[1]]: testValue };
                } else if (parts[0] === 'aiConfig') {
                    payload.aiConfig = { [parts[1]]: testValue };
                } else if (parts[0] === 'emailConfig') {
                    payload.emailConfig = { [parts[1]]: testValue };
                }
            } else {
                payload[field.backendField] = testValue;
            }
            
            return payload;
        }

        function getValueFromPath(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key], obj);
        }

        function compareValues(actual, expected) {
            if (typeof expected === 'number') {
                return Math.abs(parseFloat(actual) - expected) < 0.001;
            }
            if (typeof expected === 'boolean') {
                return Boolean(actual) === expected;
            }
            return String(actual) === String(expected);
        }

        async function runCompleteTest() {
            log('üöÄ Iniciando test completo...', 'info');
            testResults = {};
            
            for (const category of Object.keys(FIELD_DEFINITIONS)) {
                log(`üìã Probando categor√≠a: ${category}`, 'info');
                for (const field of FIELD_DEFINITIONS[category]) {
                    await testSingleField(category, field);
                    await new Promise(resolve => setTimeout(resolve, 200)); // Pausa entre tests
                }
            }
            
            log('üèÅ Test completo finalizado', 'info');
            
            const results = Object.values(testResults);
            const success = results.filter(r => r.status === 'success').length;
            const total = results.length;
            
            if (success === total) {
                log(`üéâ TODOS LOS TESTS PASARON: ${success}/${total}`, 'success');
            } else {
                log(`‚ö†Ô∏è ALGUNOS TESTS FALLARON: ${success}/${total}`, 'warning');
            }
        }

        async function testIndividualFields() {
            log('üîç Modo test individual activado', 'info');
            // Los tests individuales se ejecutan al hacer clic en cada campo
        }

        async function testPersistence() {
            log('üíæ Probando persistencia de datos...', 'info');
            // Test espec√≠fico de persistencia
        }

        function clearResults() {
            testResults = {};
            document.querySelectorAll('.field-test').forEach(el => {
                el.className = 'field-test';
                const valuesEl = el.querySelector('[id^="values-"]');
                if (valuesEl) valuesEl.innerHTML = 'Esperando test...';
            });
            updateSummary();
            document.getElementById('log').innerHTML = '';
            log('üóëÔ∏è Resultados limpiados', 'info');
        }

        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', () => {
            initializeFieldTests();
            log('üîç Herramienta de verificaci√≥n REAL iniciada', 'info');
            log('üí° Esta herramienta prueba cada campo individualmente para detectar fallos espec√≠ficos', 'info');
        });
    </script>
</body>
</html>
