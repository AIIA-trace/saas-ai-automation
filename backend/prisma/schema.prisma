// Prisma schema file actualizado para incluir las tablas del Bot
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                    Int            @id @default(autoincrement())
  email                 String         @unique
  password              String
  companyName           String
  companyDescription    String?        // Descripción de la empresa del formulario
  contactName           String
  phone                 String?
  apiKey                String?        @unique
  role                  String         @default("client")
  isActive              Boolean        @default(true)
  avatar                String?
  timezone              String         @default("UTC")
  language              String         @default("es")
  industry              String?
  website               String?
  address               String?
  stripeCustomerId      String?        @unique
  defaultPaymentMethodId String?       // ID del método de pago predeterminado
  plan                  String         @default("trial") // trial, active, past_due, cancelled
  subscriptionExpiresAt DateTime?
  trialEndDate          DateTime?
  
  // Campos de configuración del bot (exactamente como existen en la DB)
  botLanguage          String?        // Idioma del bot
  botName              String?        // Nombre del bot
  botPersonality       String?        // Personalidad del bot
  welcomeMessage       String?        // Mensaje de bienvenida
  confirmationMessage  String?        // Mensaje de confirmación

  subscriptionStatus   String?        // Estado de la suscripción
  personality          String?        // Campo personalidad adicional
  
  // Relaciones
  twilioNumbers         TwilioNumber[]
  callLogs              CallLog[]
  emailLogs             EmailLog[]
  analytics             Analytics[]
  notifications         Notification[]
  // RELACIONES LEGACY DEL BOT ELIMINADAS:
  // botAiConfigs, botDtmfOptions, botContextFiles, botFAQs
  
  // JSON configs
  // botConfig ELIMINADO - Era parte del sistema legacy
  emailConfig          Json?          // Configuración del manejo de emails
  callConfig           Json?          // Configuración de llamadas (activación, grabación, transcripción, voz, idioma, mensaje)
  companyInfo          Json?          // Información de la empresa
  billingInfo          Json?          // Información de facturación
  paymentMethods       Json?          // Métodos de pago
  notificationConfig   Json?          // Configuración de notificaciones
  businessHoursConfig  Json?          // Configuración de horarios comerciales y días laborables
  faqs                 Json?          // Preguntas frecuentes del bot
  contextFiles         Json?          // Archivos de contexto del bot
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([email])
  @@index([plan])
  @@index([subscriptionExpiresAt])
  @@index([apiKey])
}

// TABLAS LEGACY DEL BOT ELIMINADAS:
// - BotAiConfig: Configuración de IA del bot
// - BotDtmfOption: Opciones DTMF del bot  
// - BotContextFile: Archivos de contexto del bot
// - BotFAQ: Preguntas frecuentes del bot
// Todas han sido removidas como parte de la limpieza exhaustiva del sistema legacy

model TwilioNumber {
  id              Int      @id @default(autoincrement())
  clientId        Int
  client          Client   @relation(fields: [clientId], references: [id])
  phoneNumber     String   @unique
  twilioSid       String   @unique
  friendlyName    String?
  status          String   @default("active") // active, inactive
  originalNumber  String?  // Número original del cliente que está siendo redirigido
  region          String?
  capabilities    String?  // voice, sms, mms capabilities (JSON string)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([phoneNumber])
  @@index([status])
}

model CallLog {
  id                Int      @id @default(autoincrement())
  clientId          Int
  client            Client   @relation(fields: [clientId], references: [id])
  twilioCallSid     String   @unique
  callerNumber      String
  callerName        String?
  callStatus        String
  callDuration      Int?
  recordingUrl      String?
  transcription     String?
  aiSummary         String?
  aiClassification  String?
  urgencyLevel      String?  // low, medium, high
  callPurpose       String?
  contactInfo       String?  // Información de contacto extraída (JSON string)
  managed           Boolean  @default(false) // Si la llamada ha sido gestionada
  important         Boolean  @default(false) // Si la llamada está marcada como importante
  notificationSent  Boolean  @default(false)
  notifiedTo        String?  // Lista de notificados (comma separated)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([clientId])
  @@index([twilioCallSid])
  @@index([callerNumber])
  @@index([createdAt])
  @@index([aiClassification])
}

model EmailLog {
  id              Int      @id @default(autoincrement())
  clientId        Int
  client          Client   @relation(fields: [clientId], references: [id])
  messageId       String   @unique
  fromAddress     String
  fromName        String?
  toAddress       String
  subject         String
  bodyPlain       String?
  bodyHtml        String?
  attachments     String?  // Array de URLs o metadatos de adjuntos (JSON string)
  aiSummary       String?
  aiClassification String?
  forwardedTo     String?  // Lista de destinatarios (comma separated)
  favorite        Boolean  @default(false) // Si el email está marcado como favorito
  isRead          Boolean  @default(false) // Si el email ha sido leído
  responseStatus  String?  // sent, failed, none
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([messageId])
  @@index([createdAt])
  @@index([fromAddress])
}

model Analytics {
  id                Int      @id @default(autoincrement())
  clientId          Int
  client            Client   @relation(fields: [clientId], references: [id])
  date              DateTime
  totalCalls        Int      @default(0)
  totalEmails       Int      @default(0)
  missedCalls       Int      @default(0)
  answeredCalls     Int      @default(0)
  avgCallDuration   Float    @default(0)
  emailsResponded   Int      @default(0)
  emailsForwarded   Int      @default(0)
  topCallCategories String?  // JSON string
  topEmailCategories String? // JSON string
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
}

model Notification {
  id          Int      @id @default(autoincrement())
  clientId    Int
  client      Client   @relation(fields: [clientId], references: [id])
  type        String   // email, sms, app
  status      String   // sent, pending, failed
  recipient   String
  subject     String?
  content     String
  metadata    String?  // JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([type])
  @@index([status])
}
